name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Frontend CI Job
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check formatting
        run: npm run format:check
      
      - name: Run linter
        run: npm run lint
      
      - name: Run type check
        run: npx tsc --noEmit
      
      - name: Run tests
        run: npm run test:run
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
      
      - name: Build production bundle
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7

  # Backend CI Job
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend
    
    env:
      SQLX_OFFLINE: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev sqlite3 libsqlite3-dev
      
      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-
      
      - name: Cache cargo build
        uses: actions/cache@v5
        with:
          path: backend/target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-
      
      - name: Verify SQLx offline metadata
        run: |
          if [ ! -d ".sqlx" ]; then
            echo "‚ùå .sqlx directory not found!"
            echo "SQLx offline mode requires metadata to be committed to the repository."
            echo "Please run: backend/scripts/sqlx_prepare.ps1 and commit the .sqlx/ directory."
            exit 1
          fi
          echo "‚úì SQLx offline metadata found"
          find .sqlx -type f | wc -l | xargs echo "‚úì Metadata files:"
      
      - name: Check formatting
        run: cargo fmt -- --check
      
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Run tests
        run: cargo test --verbose
      
      - name: Install cargo-tarpaulin for coverage
        run: cargo install cargo-tarpaulin
      
      - name: Generate coverage report
        run: cargo tarpaulin --out Xml --output-dir ./coverage
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/cobertura.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: Build release binary
        run: cargo build --release --verbose
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: backend/target/release/easysale-server
          retention-days: 7

  # Backend Build Variants - Verify all variants compile
  backend-variants:
    name: Backend Build Variants
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        variant:
          - { name: lite, features: "" }
          - { name: export, features: "export" }
          - { name: full, features: "full" }
    
    defaults:
      run:
        working-directory: ./backend
    
    env:
      SQLX_OFFLINE: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev sqlite3 libsqlite3-dev
      
      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      - name: Cache cargo build
        uses: actions/cache@v5
        with:
          path: backend/target
          key: ${{ runner.os }}-cargo-build-variant-${{ matrix.variant.name }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-variant-${{ matrix.variant.name }}-
      
      - name: Build ${{ matrix.variant.name }} variant
        run: |
          echo "Building ${{ matrix.variant.name }} variant..."
          if [ -n "${{ matrix.variant.features }}" ]; then
            cargo build --release --no-default-features --features "${{ matrix.variant.features }}" -p easysale-server
          else
            cargo build --release --no-default-features -p easysale-server
          fi
      
      - name: Check binary size
        run: |
          BINARY="target/release/easysale-server"
          if [ -f "$BINARY" ]; then
            SIZE=$(stat -c%s "$BINARY")
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "‚úì ${{ matrix.variant.name }} binary size: ${SIZE_MB}MB"
            
            # Size thresholds
            if [ "${{ matrix.variant.name }}" = "lite" ] && [ $SIZE_MB -gt 30 ]; then
              echo "‚ö†Ô∏è WARNING: Lite binary larger than expected (>30MB)"
            fi
            if [ "${{ matrix.variant.name }}" = "full" ] && [ $SIZE_MB -gt 45 ]; then
              echo "‚ö†Ô∏è WARNING: Full binary larger than expected (>45MB)"
            fi
          else
            echo "‚ùå Binary not found!"
            exit 1
          fi
      
      - name: Verify lite build excludes heavy deps
        if: matrix.variant.name == 'lite'
        run: |
          BINARY="target/release/easysale-server"
          # Check for symbols from heavy dependencies
          SYMBOLS=$(nm "$BINARY" 2>/dev/null | grep -iE "image::|imageproc::|lopdf::" | wc -l || echo "0")
          echo "Heavy dependency symbols found: $SYMBOLS"
          if [ "$SYMBOLS" -gt 10 ]; then
            echo "‚ùå ERROR: Lite build includes heavy dependencies!"
            exit 1
          fi
          echo "‚úì Lite build correctly excludes heavy dependencies"

  # Python Services CI Job (Sync and Backup)
  python-services:
    name: Python Services CI
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [backup]  # Add 'sync' when implemented
    
    defaults:
      run:
        working-directory: ./${{ matrix.service }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: ${{ matrix.service }}/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 mypy pytest
      
      - name: Check formatting
        run: python -m black --check .
      
      - name: Run linter
        run: python -m flake8 .
      
      - name: Run type checker
        run: python -m mypy . || true  # Don't fail on type errors for now
      
      - name: Run tests
        run: python -m pytest || true  # Don't fail if no tests yet

  # Security Audit Job - Production Gate
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies (lockfile enforced)
        working-directory: ./frontend
        run: npm ci
      
      - name: Audit production dependencies (BLOCKING)
        working-directory: ./frontend
        run: |
          echo "üîí Auditing production dependencies (high/critical = blocking)"
          npm audit --omit=dev --audit-level=high
      
      - name: Audit all dependencies (informational)
        working-directory: ./frontend
        continue-on-error: true
        run: |
          echo "üìã Auditing all dependencies (informational)"
          npm audit --audit-level=moderate || echo "‚ö†Ô∏è Dev dependency vulnerabilities found (non-blocking)"
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Install cargo-audit
        run: cargo install cargo-audit
      
      - name: Run cargo audit (BLOCKING)
        working-directory: ./backend
        run: |
          echo "üîí Auditing Rust dependencies"
          cargo audit

  # Build Status Summary
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [frontend, backend, backend-variants, python-services, security]
    if: success()
    
    steps:
      - name: CI Pipeline Passed
        run: |
          echo "‚úÖ All CI checks passed successfully!"
          echo "Frontend: Built and tested"
          echo "Backend: Built and tested"
          echo "Backend Variants: All variants (lite, export, full) compile"
          echo "Python Services: Linted and tested"
          echo "Security: Audited"
