name: Production Readiness Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  readiness-scan:
    name: Production Readiness Scan
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run readiness gate scanner
        shell: pwsh
        run: |
          Write-Host "=== Production Readiness Gate ===" -ForegroundColor Cyan
          Write-Host "Scanning for forbidden patterns in core runtime paths..." -ForegroundColor Cyan
          Write-Host ""
          
          # Run the readiness gate scanner
          .\ci\readiness-gate.ps1 -OutputFormat both -Verbose
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: readiness-scan-results
          path: |
            ci/readiness-policy.json
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ Production Readiness Gate Failed
              
              The production readiness scan detected forbidden patterns in core runtime paths.
              
              **Common violations:**
              - Hardcoded demo credentials
              - CAPS branding tokens
              - Mock data arrays
              - Localhost OAuth redirect URIs
              - SQL injection vulnerabilities
              
              Please review the workflow logs for details and fix the violations before merging.
              
              See \`ci/readiness-policy.json\` for the complete policy definition.`
            });

  artifact-validation:
    name: Artifact Validation
    runs-on: windows-latest
    needs: readiness-scan
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Install system dependencies
        run: |
          choco install sqlite -y
      
      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build
      
      - name: Build backend
        working-directory: ./backend
        env:
          SQLX_OFFLINE: true
        run: |
          cargo build --release
      
      - name: Create package artifacts
        shell: pwsh
        run: |
          Write-Host "Creating package artifacts..." -ForegroundColor Cyan
          
          # Create output directory
          New-Item -ItemType Directory -Force -Path ".\dist" | Out-Null
          
          # Package frontend
          Write-Host "Packaging frontend..." -ForegroundColor Cyan
          Compress-Archive -Path ".\frontend\dist\*" -DestinationPath ".\dist\easysale-frontend.zip" -Force
          
          # Package backend
          Write-Host "Packaging backend..." -ForegroundColor Cyan
          $backendFiles = @(
            ".\backend\target\release\easysale-server.exe"
          )
          Compress-Archive -Path $backendFiles -DestinationPath ".\dist\easysale-backend.zip" -Force
          
          Write-Host "✓ Packages created" -ForegroundColor Green
      
      - name: Validate artifact contents
        shell: pwsh
        run: |
          Write-Host "=== Artifact Validation ===" -ForegroundColor Cyan
          Write-Host "Validating that excluded directories are not in packages..." -ForegroundColor Cyan
          Write-Host ""
          
          $errors = @()
          
          # Check frontend package
          Write-Host "Checking frontend package..." -ForegroundColor Cyan
          $frontendTemp = New-Item -ItemType Directory -Force -Path ".\temp\frontend"
          Expand-Archive -Path ".\dist\easysale-frontend.zip" -DestinationPath $frontendTemp -Force
          
          $excludedPaths = @("archive", "tests", "test", "fixtures", "node_modules", ".git")
          foreach ($excluded in $excludedPaths) {
            $found = Get-ChildItem -Path $frontendTemp -Recurse -Directory -Filter $excluded -ErrorAction SilentlyContinue
            if ($found) {
              $errors += "Frontend package contains excluded directory: $excluded"
              Write-Host "✗ Found excluded directory: $excluded" -ForegroundColor Red
            }
          }
          
          # Check backend package
          Write-Host "Checking backend package..." -ForegroundColor Cyan
          $backendTemp = New-Item -ItemType Directory -Force -Path ".\temp\backend"
          Expand-Archive -Path ".\dist\easysale-backend.zip" -DestinationPath $backendTemp -Force
          
          # Backend should only contain the executable
          $backendFiles = Get-ChildItem -Path $backendTemp -Recurse -File
          if ($backendFiles.Count -ne 1) {
            $errors += "Backend package should contain exactly 1 file (easysale-server.exe), found $($backendFiles.Count)"
            Write-Host "✗ Backend package contains unexpected files" -ForegroundColor Red
          }
          
          # Clean up temp directories
          Remove-Item -Path ".\temp" -Recurse -Force -ErrorAction SilentlyContinue
          
          # Report results
          if ($errors.Count -gt 0) {
            Write-Host ""
            Write-Host "=== Validation Failed ===" -ForegroundColor Red
            foreach ($error in $errors) {
              Write-Host "✗ $error" -ForegroundColor Red
            }
            exit 1
          } else {
            Write-Host ""
            Write-Host "✓ All artifact validations passed" -ForegroundColor Green
          }
      
      - name: Upload validated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: validated-packages
          path: dist/*.zip
          retention-days: 7

  readiness-gate-success:
    name: Readiness Gate Success
    runs-on: ubuntu-latest
    needs: [readiness-scan, artifact-validation]
    if: success()
    
    steps:
      - name: Production Readiness Gate Passed
        run: |
          echo "✅ Production Readiness Gate passed successfully!"
          echo "✓ No forbidden patterns detected in core runtime"
          echo "✓ Artifact validation passed"
          echo "✓ Ready for production deployment"
