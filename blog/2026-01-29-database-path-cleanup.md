# Database Path Cleanup and SQLx Offline Mode

**Date**: 2026-01-29

## Summary

Fixed sqlx offline mode preparation and cleaned up scattered database files for production readiness.

## Issue

The `cargo sqlx prepare` command was failing because:
1. The database path was incorrect (`sqlite:data/pos.db` instead of `sqlite:../data/pos.db`)
2. Multiple duplicate/test database files were scattered across the repository

## Fixes Applied

### 1. Fixed Database Path in Batch Files

Updated `build-prod.bat` and `update-prod.bat` to use the correct relative path:
- Changed: `sqlite:data/pos.db` â†’ `sqlite:../data/pos.db`
- Used `pushd/popd` instead of `cd` for safer directory navigation

### 2. Cleaned Up Test Cruft

Removed from `backend/crates/server/`:
- 60+ `test_concurrent_upload_*` directories
- 20+ `test_snapshot_*` directories
- Various `*.txt` build output files
- `fix_*.py` temporary scripts
- SQL audit/migration result files

### 3. Updated .gitignore

Added to `backend/crates/server/.gitignore`:
- `data/test_*/` - Test data directories
- `*.db-shm`, `*.db-wal` - SQLite journal files
- `*.db.backup*` - Backup files
- Build output files (`build_output.txt`, `errors*.txt`, `warnings*.txt`)
- Temporary fix scripts (`fix_*.py`)

## Canonical Database Locations

| Purpose | Path | Notes |
|---------|------|-------|
| Production | `data/pos.db` | Project root, used by Docker |
| CI Tests | `ci/data/pos.db` | Property tests |
| Backups | `runtime/backups/` | Auto-generated by update scripts |

## SQLx Offline Mode

The `.sqlx/` directory in `backend/` now contains pre-compiled query metadata, enabling:
- Docker builds without database connection
- CI builds in isolated environments
- Faster compilation (no runtime query validation)

## Verification

```bash
# Verify offline mode works
cd backend
$env:SQLX_OFFLINE="true"
cargo check --package EasySale-server
# Should complete with only deprecation warnings (expected)
```
