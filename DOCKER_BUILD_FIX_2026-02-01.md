# Docker Build Fix - SQLx Offline Mode - February 1, 2026

## Issue

Backend Docker build was failing with SQLx compile-time query verification errors:

```
error: error returned from database: (code: 14) unable to open database file
```

This occurred because SQLx was trying to connect to a database during the Docker build process to verify queries at compile time, but no database exists in the Docker build environment.

## Root Cause

The `Dockerfile.backend` was missing the `SQLX_OFFLINE=true` environment variable in the builder stage. Without this, SQLx attempts to connect to a database to verify queries, which fails in a containerized build environment.

## Solution

Added `ENV SQLX_OFFLINE=true` to the builder stage in `Dockerfile.backend`:

```dockerfile
# Enable SQLx offline mode (use cached query metadata instead of connecting to DB)
ENV SQLX_OFFLINE=true
```

This tells SQLx to use the pre-generated query metadata from the `backend/.sqlx/` directory instead of connecting to a live database.

## How SQLx Offline Mode Works

1. **Development**: Run `cargo sqlx prepare` with a live database to generate query metadata
2. **Build**: Set `SQLX_OFFLINE=true` to use cached metadata instead of database connection
3. **Docker**: Copy `.sqlx/` directory into container and use offline mode

## Query Cache Location

The query cache is stored in `backend/.sqlx/` with 42 cached query files:
- Each query has a unique hash-based filename
- Contains column types, nullability, and other metadata
- Generated by `cargo sqlx prepare --workspace`

## Verification

After this fix, the Docker build should:
1. ✅ Use cached query metadata from `.sqlx/` directory
2. ✅ Skip database connection during compilation
3. ✅ Complete successfully with all features (lite, export, full)

## Related Files

- `Dockerfile.backend` - Fixed with `SQLX_OFFLINE=true`
- `backend/.sqlx/` - Query metadata cache (42 files)
- `build-prod.bat` - Runs `cargo sqlx prepare` before Docker build

## Testing

To verify the fix works:

```cmd
# Clean build with export variant
build-prod.bat --export

# Should complete without SQLx database errors
```

## Prevention

The `build-prod.bat` script already runs `cargo sqlx prepare` before building, which updates the query cache. This ensures the cache is current before Docker build starts.

However, if the database schema changes:
1. Update migrations in `backend/migrations/`
2. Run migrations on local database
3. Run `cargo sqlx prepare --workspace` to update cache
4. Commit updated `.sqlx/` files to git

## Notes

- SQLx offline mode is **required** for Docker builds
- Query cache must be kept in sync with database schema
- Cache files should be committed to version control
- Running `cargo sqlx prepare` requires a live database

---

*Fix applied: February 1, 2026*
*Build system version: 1.1*
